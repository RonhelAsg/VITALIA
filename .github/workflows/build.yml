name: ğŸš€ Build Flutter APK - Latest Versions

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

env:
  FLUTTER_VERSION: '3.25.0'  # DerniÃ¨re stable Oct 2024
  KOTLIN_VERSION: '1.9.22'   # DerniÃ¨re stable Kotlin
  JAVA_VERSION: '21'          # LTS 2023
  GRADLE_VERSION: '8.7'       # DerniÃ¨re stable

jobs:
  build:
    name: ğŸ—ï¸ Build APK Release
    runs-on: ubuntu-latest

    steps:
    # Ã‰tape 1: Checkout du code
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    # Ã‰tape 2: Configuration Java 21 LTS
    - name: â˜• Setup Java ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
        cache: 'gradle'

    # Ã‰tape 3: Configuration Android SDK
    - name: ğŸ¤– Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 34          # Android 14
        build-tools-version: '34.0.0'
        cmake-version: '3.22.1'
        ndk-version: '25.2.9519653'

    # Ã‰tape 4: Configuration Flutter derniÃ¨re version
    - name: ğŸ“± Setup Flutter ${{ env.FLUTTER_VERSION }}
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
        cache-key: flutter-${{ env.FLUTTER_VERSION }}
        cache-path: ${{ github.workspace }}/.pub-cache

    # Ã‰tape 5: Acceptation des licenses Android
    - name: ğŸ“ Accept Android Licenses
      run: |
        yes | sdkmanager --licenses || true
        flutter doctor --android-licenses --verbose

    # Ã‰tape 6: Informations de debug
    - name: ğŸ” Debug Information
      run: |
        echo "=== VERSIONS ==="
        flutter --version
        echo "=== DART ==="
        dart --version
        echo "=== JAVA ==="
        java -version
        echo "=== ANDROID SDK ==="
        sdkmanager --list | head -20

    # Ã‰tape 7: VÃ©rification de l'environnement
    - name: ğŸ©º Flutter Doctor
      run: flutter doctor -v

    # Ã‰tape 8: Mise Ã  jour de Kotlin dans le projet (AUTO)
    - name: ğŸ”„ Upgrade Kotlin to ${{ env.KOTLIN_VERSION }}
      run: |
        # Mise Ã  jour automatique de Kotlin dans build.gradle
        sed -i 's/ext.kotlin_version = [\"'\'']1\.[0-9]\+\.[0-9]\+[\"'\'']/ext.kotlin_version = "'$KOTLIN_VERSION'"/' android/build.gradle 2>/dev/null || true
        
        # Alternative pour settings.gradle
        sed -i 's/id '\''org.jetbrains.kotlin.android'\'' version [\"'\'']1\.[0-9]\+\.[0-9]\+[\"'\'']/id '\''org.jetbrains.kotlin.android'\'' version "'$KOTLIN_VERSION'"/' android/settings.gradle 2>/dev/null || true
        
        echo "âœ… Kotlin upgraded to $KOTLIN_VERSION"

    # Ã‰tape 9: Nettoyage et installation
    - name: ğŸ§¹ Clean & Install Dependencies
      run: |
        flutter clean
        flutter pub get
        cd android && ./gradlew clean && cd ..

    # Ã‰tape 10: Build APK Release
    - name: ğŸ—ï¸ Build APK Release
      run: |
        flutter build apk --release \
          --dart-define=BUILD_ENV=production \
          --dart-define=BUILD_VERSION=${{ github.run_number }} \
          --verbose

    # Ã‰tape 11: Build AAB (Bonus pour Play Store)
    - name: ğŸ“¦ Build AAB Bundle
      run: |
        flutter build appbundle --release \
          --dart-define=BUILD_ENV=production \
          --dart-define=BUILD_VERSION=${{ github.run_number }}

    # Ã‰tape 12: Upload des artefacts
    - name: ğŸ“¤ Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: flutter-build-${{ github.run_number }}
        path: |
          build/app/outputs/flutter-apk/app-release.apk
          build/app/outputs/bundle/release/app-release.aab
        retention-days: 30
        compression-level: 9

    # Ã‰tape 13: Notification de succÃ¨s
    - name: âœ… Build Success
      if: success()
      run: |
        echo "ğŸ‰ BUILD SUCCESSFUL!"
        echo "ğŸ“± APK: app-release.apk"
        echo "ğŸª AAB: app-release.aab"
        echo "ğŸ”¢ Build: ${{ github.run_number }}"

  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: build
    if: always()

    steps:
    - name: ğŸ“¥ Download Artifact
      uses: actions/download-artifact@v4
      with:
        name: flutter-build-${{ github.run_number }}

    - name: ğŸ” APK Analysis
      run: |
        echo "ğŸ“Š APK File Info:"
        file app-release.apk || true
        echo "ğŸ“¦ APK Size:"
        du -h app-release.apk || true
